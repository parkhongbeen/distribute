# docker

## docker란 무엇인가?

도커는 *컨테이너 기반의 오픈소스 가상화 플랫폼*입니다.

서버에서 이야기하는 컨테이너는 다양한 프로그램,실행환경을 컨테이너로 추상화하고 동일한 인터페이스를 제공하여 프로그램의 배포 및 관리를 단순하게 해줍니다.백엔드 프로그램, 데이터베이스 서버, 메시지 큐등 어떤 프로그램도 컨테이너로 추상화할 수 있고 조립PC, AWS, Azure, Goole cloud등 어디에서든 실행할 수 있습니다.

기존에 전가상화든 반가상화든 추가적인 OS를 설치하여 가상화하는 방법은 어쨋든 성능문제가 있었고 이를 개선하기 위해 *프로세스를 격리*하는 방식이 등장합니다.

리눅스에서는 이 방식을 리눅스 컨테이너라고 하고 단순히 프로세스를 격리시키기 때문에 가볍고 빠르게 동작합니다.CPU나 메모리는 딱 프로레스가 필요한 만큼만 추가로 사용하고 성능적으로도 거의 손실이 없습니다.

docker에거 가장 중요한 개념은 컨테이너와 함께 이미지라는 개념입니다.

이미지는 *컨테이너 실행에 필요한 파일과 설정값등을 포함하고 있는 것*으로 상태값을 가지지 않고 변하지 않습니다.컨테이너는 이미지를 실행한 상태라고 볼 수 있고 추가되거나 변하는 값은 컨테이너에 저장됩니다.

말그대로 이밎는 컨테이너를 실행하기 위한 모든 정보를 가지고 있기 때문에 더 이상 의존성 파일을 컴파일하고 이것저것 설치할 필요가 없습니다.이제 새로운 서버가 추가되면 미리 만들어 놓은 이미지를 다운받고 컨테이너를 생성만 하면 됩니다. 한 서버에 여러개의 컨테이너를 실행할 수 있고 수십,수백,수천대의 서버도 문제없습니다.

#### 레이어 저장방식

도커이미지는 컨테이너를 실행하기 위한 모든 정보를 가지고 있기 때문에 보통 용량이 수백메가에 이릅니다.처음 이미지를 다운받을 땐 크게 부담이 안되지만 기존 이미지에 파일 하나 추가했다고 수백메가를 다시 다운받는다면 매우 비효율적일 수 밖에 없습니다.도커는 이런 문제를 해결하기 위해 *레이어*라는 개념을 사용하고 유니온 파일 시스템을 이용하여 여러개의 레이어를 하나의 파일시스템으로 사용할 수 있게 해줍니다.이미지는 여러개의 읽기전용(read only)레이어로 구성되어 파일이 추가되거나 수정되면 새로운 레이어가 생성됩니다.

예를 들어, ubuntu이미지가 A + B + C 의 집합이라면, ubuntu이미지를 베이스로 만든 nginx이미지는 A + B + C +nginx가 됩니다. webapp이미지를 nginx이미지 기반으로 만들었다면 A + B + C + nginx + source 레이어로 구성됩니다.때문에 굉장히 효율적으로 이미지를 관리할 수 있습니다.

### Dockerfile

도커는 이미지를 만들기 위해 `Dockerfile`이라는 파일에 자체 DSL언어를 이용하여 이미지 생성 과정을 적습니다.추후에 문법에 대해 자세히 다루겠지만 위 샘플을 보면 그렇게 복잡하지 않다는 걸 알 수 있습니다.

이것은 굉장히 간단하지만 유용한 아이디어인데, 서버에 어떤 프로그램을 설치하려고 이것저것 의존성 패키지를 설치하고 설정파일을 만들었던 경험이 있다면 더 이상 그 과정을 블로깅하거나 메모장에 적지 말고 `Dockerfile`로 관리하면 됩니다.이 파일은 소스와 함께 버전 관리되고 원한다면 누구나 이미지 생성과정을 보고 수정할 수 있습니다.

### Docker Hub

도커 이미지의 용량은 보통 수백메가로 수기가가 넘는 경우도 흔합니다. 이렇게 큰 용량의 이미지를 서버에 저장하고 관리하는 것은 쉽지 않은데 도커는 Docker hub를 통해 공개 이미지를 무료로 관리해 줍니다.

### mac에서 docker다운받기

```
$ brew cask install docker
```

### 컨테이너 실행하기

`$ docker run --rm -it ubuntu /bin/bash` 

자주 사용하는 옵션

| 옵션  | 설명                                                     |
| ----- | -------------------------------------------------------- |
| -d    | detached mode 흔히 말하는 백그라운드 모드                |
| -p    | 호스트와 컨테이너의 포트를 연결                          |
| -v    | 호스트와 컨테이너의 디렉토리를 연결                      |
| -e    | 컨테이너내에서 사용할 환경변수 설정                      |
| -name | 컨테이너 이름 설정                                       |
| -rm   | 프로세스 종료시 컨테이너 자동 제거                       |
| -it   | -i와 -t를 동시에 사용하는 것으로 터미널 입력을 위한 옵션 |
| -link | 컨테이너 연결                                            |

### 컨테이너 내부로 들어감

`$ docker run --rm -it -p 8001:8000 instagram /bin/bash`

### 이미지 목록 확인하기(images)

`$ docker images`

#이미지 삭제하기

`$ docker rmi [OPTIONS] IMAGE [IMAGE...]`

## 도커 이미지 만들기

도커는 이미지를 만들기 위해 *컨테이너의 상태를 그대로 이미지로 저장*하는 단순한 방법을 사용합니다.

빌드파일 작성 후 아래의 명령어를 실행합니다.

### Docker build

` $ docker build -t instagram -f Dockerfile . `

`$ docker login`

